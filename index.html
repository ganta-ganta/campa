<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campa Beverages - Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
    }
    .sidebar {
      background-color: #2c3e50;
      color: white;
      height: 100vh;
      position: fixed;
      padding-top: 20px;
    }
    .sidebar a {
      color: #ecf0f1;
      padding: 10px 15px;
      display: block;
      text-decoration: none;
      transition: all 0.3s;
    }
    .sidebar a:hover {
      background-color: #34495e;
      color: #fff;
    }
    .sidebar a.active {
      background-color: #3498db;
    }
    .main-content {
      margin-left: 250px;
      padding: 20px;
    }
    .card {
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      border: none;
    }
    .card-header {
      background-color: #3498db;
      color: white;
      border-radius: 10px 10px 0 0 !important;
    }
    .hidden {
      display: none;
    }
    .stock-details {
      background-color: #f8f9fa;
      padding: 10px;
      margin-top: 5px;
      border-radius: 5px;
    }
    .dashboard-card {
      transition: transform 0.3s;
    }
    .dashboard-card:hover {
      transform: translateY(-5px);
    }
    .chart-container {
      height: 300px;
      width: 100%;
    }
    .badge-pending {
      background-color: #ffc107;
      color: #212529;
    }
    .badge-approved {
      background-color: #28a745;
      color: white;
    }
    .badge-rejected {
      background-color: #dc3545;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 d-md-block sidebar collapse">
        <div class="text-center mb-4">
          <h3>Campa Beverages</h3>
          <p class="text-muted">Admin Dashboard</p>
        </div>
        <ul class="nav flex-column">
          <li class="nav-item">
            <a href="#" class="nav-link active" onclick="showSection('dashboard')">
              <i class="fas fa-tachometer-alt me-2"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('vanStock')">
              <i class="fas fa-truck me-2"></i> Van Stock
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('stockRequests')">
              <i class="fas fa-clipboard-list me-2"></i> Stock Requests
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('invoices')">
              <i class="fas fa-file-invoice me-2"></i> Invoices
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('products')">
              <i class="fas fa-wine-bottle me-2"></i> Products
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('users')">
              <i class="fas fa-users me-2"></i> Users
            </a>
          </li>
          <li class="nav-item mt-4">
            <a href="#" class="nav-link text-danger" onclick="logout()">
              <i class="fas fa-sign-out-alt me-2"></i> Logout
            </a>
          </li>
        </ul>
      </div>

      <!-- Main Content -->
      <div class="col-md-9 col-lg-10 ms-sm-auto main-content">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
          <h2 class="mb-4">Dashboard Overview</h2>
          
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card dashboard-card text-white bg-primary">
                <div class="card-body">
                  <h5 class="card-title">Total Operators</h5>
                  <h2 id="totalOperators" class="card-text">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card dashboard-card text-white bg-success">
                <div class="card-body">
                  <h5 class="card-title">Active Stock</h5>
                  <h2 id="totalStock" class="card-text">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card dashboard-card text-white bg-warning">
                <div class="card-body">
                  <h5 class="card-title">Pending Requests</h5>
                  <h2 id="pendingRequests" class="card-text">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card dashboard-card text-white bg-info">
                <div class="card-body">
                  <h5 class="card-title">Today's Sales</h5>
                  <h2 id="todaysSales" class="card-text">â‚¹0</h2>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5>Stock Distribution</h5>
                </div>
                <div class="card-body">
                  <div id="stockChart" class="chart-container"></div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5>Recent Activities</h5>
                </div>
                <div class="card-body">
                  <div id="recentActivities" class="list-group">
                    <!-- Activities will be loaded here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row mt-4">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  <h5>Low Stock Alerts</h5>
                </div>
                <div class="card-body">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Product</th>
                        <th>Size</th>
                        <th>Operator</th>
                        <th>Remaining</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody id="lowStockAlerts">
                      <!-- Low stock alerts will be loaded here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Van Stock Section -->
        <div id="vanStock" class="section hidden">
          <h2 class="mb-4">Van Stock Management</h2>
          <div class="card">
            <div class="card-header">
              <h5>Van Operators Summary</h5>
            </div>
            <div class="card-body">
              <div id="vanOperatorsSummary">
                <!-- Van operators summary will be loaded here -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Stock Requests Section -->
        <div id="stockRequests" class="section hidden">
          <h2 class="mb-4">Stock Requests</h2>
          <div class="card">
            <div class="card-header">
              <h5>Pending Stock Approvals</h5>
            </div>
            <div class="card-body">
              <div id="pendingStockApprovals">
                <!-- Pending stock approvals will be loaded here -->
              </div>
            </div>
          </div>
          
          <div class="card mt-4">
            <div class="card-header">
              <h5>Request History</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <input type="text" id="searchRequests" class="form-control" placeholder="Search requests...">
              </div>
              <div id="stockRequestHistory">
                <!-- Stock request history will be loaded here -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Invoices Section -->
        <div id="invoices" class="section hidden">
          <h2 class="mb-4">Invoice Management</h2>
          <div class="card">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h5>Recent Invoices</h5>
                <button class="btn btn-primary btn-sm" onclick="generateSampleInvoice()">
                  <i class="fas fa-plus me-1"></i> Generate Sample
                </button>
              </div>
            </div>
            <div class="card-body">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Invoice ID</th>
                    <th>Date</th>
                    <th>Customer</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="invoiceList">
                  <!-- Invoices will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Products Section -->
        <div id="products" class="section hidden">
          <h2 class="mb-4">Product Management</h2>
          <div class="card">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h5>Product List</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
                  <i class="fas fa-plus me-1"></i> Add Product
                </button>
              </div>
            </div>
            <div class="card-body">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Size</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="productList">
                  <!-- Products will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Users Section -->
        <div id="users" class="section hidden">
          <h2 class="mb-4">User Management</h2>
          <div class="card">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h5>User List</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
                  <i class="fas fa-user-plus me-1"></i> Add User
                </button>
              </div>
            </div>
            <div class="card-body">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="userList">
                  <!-- Users will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="productForm">
            <div class="mb-3">
              <label for="productName" class="form-label">Product Name</label>
              <input type="text" class="form-control" id="productName" required>
            </div>
            <div class="mb-3">
              <label for="productSize" class="form-label">Size</label>
              <input type="text" class="form-control" id="productSize" required>
            </div>
            <div class="mb-3">
              <label for="productPrice" class="form-label">Price (â‚¹)</label>
              <input type="number" class="form-control" id="productPrice" step="0.01" required>
            </div>
            <div class="mb-3">
              <label for="productDescription" class="form-label">Description</label>
              <textarea class="form-control" id="productDescription" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="addProduct()">Save Product</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add User Modal -->
  <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="userForm">
            <div class="mb-3">
              <label for="userName" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="userName" required>
            </div>
            <div class="mb-3">
              <label for="userEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="userEmail" required>
            </div>
            <div class="mb-3">
              <label for="userRole" class="form-label">Role</label>
              <select class="form-select" id="userRole" required>
                <option value="admin">Admin</option>
                <option value="operator">Operator</option>
                <option value="sales">Sales</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="userPassword" class="form-label">Password</label>
              <input type="password" class="form-control" id="userPassword" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="addUser()">Save User</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Invoice Modal -->
  <div class="modal fade" id="viewInvoiceModal" tabindex="-1" aria-labelledby="viewInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewInvoiceModalLabel">Invoice Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="invoiceDetails">
          <!-- Invoice details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="printInvoice()">
            <i class="fas fa-print me-1"></i> Print
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    let currentUser = null;

    // Google Charts loader
    google.charts.load('current', {'packages':['corechart']});
    
    // Check authentication state
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        console.log("User logged in:", user.email);
        loadDashboardData();
        loadVanOperatorsSummary();
        loadPendingStockApprovals();
        loadStockRequestHistory();
        loadInvoices();
        loadProducts();
        loadUsers();
      } else {
        window.location.href = "login.html";
      }
    });

    // Show section function
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
      });
      document.getElementById(sectionId).classList.remove('hidden');
      
      // Update active link in sidebar
      document.querySelectorAll('.sidebar a').forEach(link => {
        link.classList.remove('active');
      });
      event.target.classList.add('active');
    }

    // Logout function
    function logout() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }

    // Dashboard functions
    async function loadDashboardData() {
      try {
        // Load total operators
        const operatorsSnapshot = await db.collection('users').where('role', '==', 'operator').get();
        document.getElementById('totalOperators').textContent = operatorsSnapshot.size;
        
        // Load total stock
        let totalStock = 0;
        const vanStockSnapshot = await db.collection('vanStock').get();
        vanStockSnapshot.forEach(doc => {
          const stock = doc.data().stock;
          for (const key in stock) {
            totalStock += stock[key].remaining;
          }
        });
        document.getElementById('totalStock').textContent = totalStock;
        
        // Load pending requests
        const pendingRequestsSnapshot = await db.collection('stockRequests').where('status', '==', 'pending').get();
        document.getElementById('pendingRequests').textContent = pendingRequestsSnapshot.size;
        
        // Load today's sales
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const invoicesSnapshot = await db.collection('invoices')
          .where('date', '>=', today)
          .get();
        
        let totalSales = 0;
        invoicesSnapshot.forEach(doc => {
          totalSales += doc.data().totalAmount;
        });
        document.getElementById('todaysSales').textContent = `â‚¹${totalSales.toFixed(2)}`;
        
        // Load stock distribution chart
        loadStockDistributionChart();
        
        // Load recent activities
        loadRecentActivities();
        
        // Load low stock alerts
        loadLowStockAlerts();
      } catch (error) {
        console.error("Error loading dashboard data:", error);
      }
    }

    function loadStockDistributionChart() {
      // In a real app, you would fetch this data from Firestore
      const data = google.visualization.arrayToDataTable([
        ['Product', 'Quantity'],
        ['Campa Cola (300ml)', 1200],
        ['Campa Orange (300ml)', 800],
        ['Campa Lemon (300ml)', 600],
        ['Campa Cola (500ml)', 1500],
        ['Campa Orange (500ml)', 900],
        ['Campa Lemon (500ml)', 700]
      ]);

      const options = {
        title: 'Stock Distribution by Product',
        is3D: true,
      };

      const chart = new google.visualization.PieChart(document.getElementById('stockChart'));
      chart.draw(data, options);
    }

    async function loadRecentActivities() {
      try {
        const activitiesRef = db.collection('activities').orderBy('timestamp', 'desc').limit(5);
        const snapshot = await activitiesRef.get();
        
        let html = '';
        snapshot.forEach(doc => {
          const activity = doc.data();
          html += `
            <div class="list-group-item list-group-item-action">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${activity.title}</h6>
                <small>${new Date(activity.timestamp.toDate()).toLocaleString()}</small>
              </div>
              <p class="mb-1">${activity.description}</p>
              <small>By: ${activity.user}</small>
            </div>
          `;
        });
        
        document.getElementById('recentActivities').innerHTML = html;
      } catch (error) {
        console.error("Error loading recent activities:", error);
      }
    }

    async function loadLowStockAlerts() {
      try {
        const threshold = 10; // Define your low stock threshold
        const vanStockSnapshot = await db.collection('vanStock').get();
        
        let alerts = [];
        vanStockSnapshot.forEach(doc => {
          const stock = doc.data().stock;
          for (const key in stock) {
            if (stock[key].remaining <= threshold) {
              alerts.push({
                operator: doc.id,
                product: stock[key].name,
                size: stock[key].size,
                remaining: stock[key].remaining
              });
            }
          }
        });
        
        let html = '';
        if (alerts.length === 0) {
          html = '<tr><td colspan="5" class="text-center">No low stock alerts</td></tr>';
        } else {
          alerts.forEach(alert => {
            html += `
              <tr>
                <td>${alert.product}</td>
                <td>${alert.size}</td>
                <td>${alert.operator.substring(0, 8)}...</td>
                <td class="text-danger fw-bold">${alert.remaining}</td>
                <td>
                  <button class="btn btn-sm btn-warning" onclick="restockAlert('${alert.operator}', '${alert.product}', '${alert.size}')">
                    Restock
                  </button>
                </td>
              </tr>
            `;
          });
        }
        
        document.getElementById('lowStockAlerts').innerHTML = html;
      } catch (error) {
        console.error("Error loading low stock alerts:", error);
      }
    }

    function restockAlert(operatorId, productName, productSize) {
      // In a real app, this would create a restock request or open a form
      alert(`Restock requested for ${productName} (${productSize}) for operator ${operatorId.substring(0, 8)}...`);
    }

    // Van Stock functions
    async function loadVanOperatorsSummary() {
      try {
        const querySnapshot = await db.collection('vanStock').get();
        let html = '<table class="table table-hover"><thead><tr><th>Operator</th><th>Products</th><th>Total Stock</th><th>Details</th></tr></thead><tbody>';
        
        querySnapshot.forEach(doc => {
          const stock = doc.data().stock;
          let productCount = 0;
          let totalStock = 0;
          let stockDetails = '';
          
          for (const key in stock) {
            productCount++;
            totalStock += stock[key].remaining;
            stockDetails += `
              <div class="stock-item mb-2">
                <strong>${stock[key].name}</strong> (${stock[key].size}):
                <span class="badge bg-primary">Loaded: ${stock[key].loaded}</span>
                <span class="badge bg-success">Sold: ${stock[key].sold}</span>
                <span class="badge bg-info">Remaining: ${stock[key].remaining}</span>
              </div>
            `;
          }
          
          html += `
            <tr>
              <td>${doc.id.substring(0, 8)}...</td>
              <td>${productCount}</td>
              <td>${totalStock}</td>
              <td>
                <button class="btn btn-info btn-sm" onclick="viewOperatorStock('${doc.id}')">
                  <i class="fas fa-eye me-1"></i> View Details
                </button>
                <div id="stockDetails-${doc.id}" class="stock-details hidden mt-2">
                  ${stockDetails}
                </div>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        document.getElementById('vanOperatorsSummary').innerHTML = html;
      } catch (error) {
        console.error("Error loading van operators summary:", error);
      }
    }

    function viewOperatorStock(operatorId) {
      const detailsDiv = document.getElementById(`stockDetails-${operatorId}`);
      detailsDiv.classList.toggle('hidden');
      
      const button = event.target;
      if (detailsDiv.classList.contains('hidden')) {
        button.innerHTML = '<i class="fas fa-eye me-1"></i> View Details';
      } else {
        button.innerHTML = '<i class="fas fa-eye-slash me-1"></i> Hide Details';
      }
    }

    // Stock Request functions
    async function loadPendingStockApprovals() {
      try {
        const querySnapshot = await db.collection('stockRequests')
          .where('status', '==', 'pending')
          .orderBy('requestedAt', 'desc')
          .get();
        
        if (querySnapshot.empty) {
          document.getElementById('pendingStockApprovals').innerHTML = `
            <div class="alert alert-info">No pending stock requests</div>
          `;
          return;
        }
        
        let html = '<table class="table table-hover"><thead><tr><th>Operator</th><th>Product</th><th>Size</th><th>Qty</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
        
        querySnapshot.forEach(doc => {
          const request = doc.data();
          html += `
            <tr>
              <td>${request.operatorId.substring(0, 8)}...</td>
              <td>${request.productName}</td>
              <td>${request.productSize}</td>
              <td>${request.quantity}</td>
              <td>${request.requestedAt.toDate().toLocaleString()}</td>
              <td>
                <button class="btn btn-success btn-sm me-1" onclick="approveStockRequest('${doc.id}', '${request.operatorId}', '${request.productName}', '${request.productSize}', ${request.quantity})">
                  <i class="fas fa-check me-1"></i> Approve
                </button>
                <button class="btn btn-danger btn-sm" onclick="rejectStockRequest('${doc.id}')">
                  <i class="fas fa-times me-1"></i> Reject
                </button>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        document.getElementById('pendingStockApprovals').innerHTML = html;
      } catch (error) {
        console.error("Error loading pending stock approvals:", error);
      }
    }

    async function approveStockRequest(requestId, operatorId, productName, productSize, quantity) {
      try {
        if (!confirm(`Approve request for ${quantity} ${productName} (${productSize})?`)) return;
        
        // Update request status
        await db.collection('stockRequests').doc(requestId).update({
          status: 'approved',
          approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
          approvedBy: currentUser.email
        });
        
        // Get current stock
        const vanStockRef = db.collection('vanStock').doc(operatorId);
        const vanStockDoc = await vanStockRef.get();
        
        let stockData = vanStockDoc.exists() ? vanStockDoc.data().stock : {};
        const productKey = `${productName}|${productSize}`;
        
        // Initialize product if it doesn't exist
        if (!stockData[productKey]) {
          stockData[productKey] = {
            name: productName,
            size: productSize,
            loaded: 0,
            sold: 0,
            remaining: 0
          };
        }
        
        // Update stock values
        stockData[productKey].loaded += parseInt(quantity);
        stockData[productKey].remaining += parseInt(quantity);
        
        // Save updated stock
        await vanStockRef.set({ 
          stock: stockData,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        // Log activity
        await db.collection('activities').add({
          title: 'Stock Request Approved',
          description: `Approved ${quantity} ${productName} (${productSize}) for operator ${operatorId.substring(0, 8)}...`,
          user: currentUser.email,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('Stock request approved and updated!');
        loadPendingStockApprovals();
        loadVanOperatorsSummary();
        loadDashboardData();
      } catch (error) {
        alert('Error approving stock request: ' + error.message);
      }
    }

    async function rejectStockRequest(requestId) {
      try {
        if (!confirm('Reject this stock request?')) return;
        
        await db.collection('stockRequests').doc(requestId).update({
          status: 'rejected',
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
          rejectedBy: currentUser.email
        });
        
        // Log activity
        await db.collection('activities').add({
          title: 'Stock Request Rejected',
          description: `Rejected stock request ID: ${requestId}`,
          user: currentUser.email,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('Stock request rejected!');
        loadPendingStockApprovals();
        loadDashboardData();
      } catch (error) {
        alert('Error rejecting stock request: ' + error.message);
      }
    }

    async function loadStockRequestHistory() {
      try {
        const querySnapshot = await db.collection('stockRequests')
          .orderBy('requestedAt', 'desc')
          .limit(50)
          .get();
        
        let html = '<table class="table table-hover"><thead><tr><th>Operator</th><th>Product</th><th>Size</th><th>Qty</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
        
        querySnapshot.forEach(doc => {
          const request = doc.data();
          let statusBadge = '';
          
          if (request.status === 'approved') {
            statusBadge = '<span class="badge bg-success">Approved</span>';
          } else if (request.status === 'rejected') {
            statusBadge = '<span class="badge bg-danger">Rejected</span>';
          } else {
            statusBadge = '<span class="badge bg-warning">Pending</span>';
          }
          
          html += `
            <tr>
              <td>${request.operatorId.substring(0, 8)}...</td>
              <td>${request.productName}</td>
              <td>${request.productSize}</td>
              <td>${request.quantity}</td>
              <td>${statusBadge}</td>
              <td>${request.requestedAt.toDate().toLocaleString()}</td>
              <td>
                <button class="btn btn-info btn-sm" onclick="viewRequestDetails('${doc.id}')">
                  <i class="fas fa-info-circle me-1"></i> Details
                </button>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        document.getElementById('stockRequestHistory').innerHTML = html;
        
        // Add search functionality
        document.getElementById('searchRequests').addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const rows = document.querySelectorAll('#stockRequestHistory tbody tr');
          
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        });
      } catch (error) {
        console.error("Error loading stock request history:", error);
      }
    }

    async function viewRequestDetails(requestId) {
      try {
        const doc = await db.collection('stockRequests').doc(requestId).get();
        if (!doc.exists) {
          alert('Request not found');
          return;
        }
        
        const request = doc.data();
        let details = `
          <h5>Request Details</h5>
          <p><strong>Operator ID:</strong> ${request.operatorId}</p>
          <p><strong>Product:</strong> ${request.productName} (${request.productSize})</p>
          <p><strong>Quantity:</strong> ${request.quantity}</p>
          <p><strong>Status:</strong> ${request.status}</p>
          <p><strong>Requested At:</strong> ${request.requestedAt.toDate().toLocaleString()}</p>
        `;
        
        if (request.status === 'approved') {
          details += `
            <p><strong>Approved By:</strong> ${request.approvedBy}</p>
            <p><strong>Approved At:</strong> ${request.approvedAt.toDate().toLocaleString()}</p>
          `;
        } else if (request.status === 'rejected') {
          details += `
            <p><strong>Rejected By:</strong> ${request.rejectedBy}</p>
            <p><strong>Rejected At:</strong> ${request.rejectedAt.toDate().toLocaleString()}</p>
          `;
        }
        
        alert(details);
      } catch (error) {
        console.error("Error viewing request details:", error);
      }
    }

    // Invoice functions
    async function loadInvoices() {
      try {
        const querySnapshot = await db.collection('invoices')
          .orderBy('date', 'desc')
          .limit(10)
          .get();
        
        let html = '';
        querySnapshot.forEach(doc => {
          const invoice = doc.data();
          html += `
            <tr>
              <td>${doc.id.substring(0, 8)}...</td>
              <td>${invoice.date.toDate().toLocaleDateString()}</td>
              <td>${invoice.customerName || 'Walk-in Customer'}</td>
              <td>â‚¹${invoice.totalAmount.toFixed(2)}</td>
              <td>
                <span class="badge ${invoice.paid ? 'bg-success' : 'bg-warning'}">
                  ${invoice.paid ? 'Paid' : 'Pending'}
                </span>
              </td>
              <td>
                <button class="btn btn-primary btn-sm" onclick="viewInvoice('${doc.id}')">
                  <i class="fas fa-eye me-1"></i> View
                </button>
              </td>
            </tr>
          `;
        });
        
        document.getElementById('invoiceList').innerHTML = html;
      } catch (error) {
        console.error("Error loading invoices:", error);
      }
    }

    async function viewInvoice(invoiceId) {
      try {
        const doc = await db.collection('invoices').doc(invoiceId).get();
        if (!doc.exists) {
          alert('Invoice not found');
          return;
        }
        
        const invoice = doc.data();
        let itemsHtml = '';
        
        invoice.items.forEach(item => {
          itemsHtml += `
            <tr>
              <td>${item.name}</td>
              <td>${item.size}</td>
              <td>${item.quantity}</td>
              <td>â‚¹${item.price.toFixed(2)}</td>
              <td>â‚¹${(item.quantity * item.price).toFixed(2)}</td>
            </tr>
          `;
        });
        
        const invoiceHtml = `
          <div class="invoice-container">
            <div class="text-center mb-4">
              <h3>Campa Beverages</h3>
              <p class="text-muted">Invoice #${doc.id.substring(0, 8)}</p>
            </div>
            
            <div class="row mb-4">
              <div class="col-md-6">
                <h5>Customer Details</h5>
                <p><strong>Name:</strong> ${invoice.customerName || 'Walk-in Customer'}</p>
                <p><strong>Date:</strong> ${invoice.date.toDate().toLocaleString()}</p>
              </div>
              <div class="col-md-6 text-end">
                <h5>Operator</h5>
                <p>${invoice.operatorId}</p>
              </div>
            </div>
            
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Size</th>
                  <th>Qty</th>
                  <th>Price</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                ${itemsHtml}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                  <td>â‚¹${invoice.subtotal.toFixed(2)}</td>
                </tr>
                <tr>
                  <td colspan="4" class="text-end"><strong>Tax (5%):</strong></td>
                  <td>â‚¹${invoice.tax.toFixed(2)}</td>
                </tr>
                <tr>
                  <td colspan="4" class="text-end"><strong>Total:</strong></td>
                  <td>â‚¹${invoice.totalAmount.toFixed(2)}</td>
                </tr>
              </tfoot>
            </table>
            
            <div class="mt-4">
              <p class="text-muted">Thank you for your business!</p>
            </div>
          </div>
        `;
        
        document.getElementById('invoiceDetails').innerHTML = invoiceHtml;
        const modal = new bootstrap.Modal(document.getElementById('viewInvoiceModal'));
        modal.show();
      } catch (error) {
        console.error("Error viewing invoice:", error);
      }
    }

    function printInvoice() {
      const printContents = document.getElementById('invoiceDetails').innerHTML;
      const originalContents = document.body.innerHTML;
      
      document.body.innerHTML = printContents;
      window.print();
      document.body.innerHTML = originalContents;
      
      // Re-show the modal after printing
      const modal = new bootstrap.Modal(document.getElementById('viewInvoiceModal'));
      modal.show();
    }

    function generateSampleInvoice() {
      // In a real app, this would create a real invoice in the database
      alert("Sample invoice generation would be implemented here");
    }

    // Product functions
    async function loadProducts() {
      try {
        const querySnapshot = await db.collection('products').get();
        let html = '';
        
        querySnapshot.forEach(doc => {
          const product = doc.data();
          html += `
            <tr>
              <td>${product.name}</td>
              <td>${product.size}</td>
              <td>â‚¹${product.price.toFixed(2)}</td>
              <td>${product.stock || 0}</td>
              <td>
                <button class="btn btn-sm btn-warning me-1" onclick="editProduct('${doc.id}')">
                  <i class="fas fa-edit me-1"></i> Edit
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteProduct('${doc.id}')">
                  <i class="fas fa-trash me-1"></i> Delete
                </button>
              </td>
            </tr>
          `;
        });
        
        document.getElementById('productList').innerHTML = html;
      } catch (error) {
        console.error("Error loading products:", error);
      }
    }

    async function addProduct() {
      try {
        const productName = document.getElementById('productName').value;
        const productSize = document.getElementById('productSize').value;
        const productPrice = parseFloat(document.getElementById('productPrice').value);
        const productDescription = document.getElementById('productDescription').value;
        
        if (!productName || !productSize || isNaN(productPrice)) {
          alert('Please fill in all required fields');
          return;
        }
        
        await db.collection('products').add({
          name: productName,
          size: productSize,
          price: productPrice,
          description: productDescription,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Log activity
        await db.collection('activities').add({
          title: 'Product Added',
          description: `Added new product: ${productName} (${productSize})`,
          user: currentUser.email,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('Product added successfully!');
        document.getElementById('productForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
        loadProducts();
        loadDashboardData();
      } catch (error) {
        console.error("Error adding product:", error);
        alert('Error adding product: ' + error.message);
      }
    }

    function editProduct(productId) {
      // In a real app, this would open an edit modal
      alert(`Edit product with ID: ${productId}`);
    }

    async function deleteProduct(productId) {
      try {
        if (!confirm('Are you sure you want to delete this product?')) return;
        
        await db.collection('products').doc(productId).delete();
        
        // Log activity
        await db.collection('activities').add({
          title: 'Product Deleted',
          description: `Deleted product ID: ${productId}`,
          user: currentUser.email,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('Product deleted successfully!');
        loadProducts();
        loadDashboardData();
      } catch (error) {
        console.error("Error deleting product:", error);
        alert('Error deleting product: ' + error.message);
      }
    }

    // User functions
    async function loadUsers() {
      try {
        const querySnapshot = await db.collection('users').get();
        let html = '';
        
        querySnapshot.forEach(doc => {
          const user = doc.data();
          html += `
            <tr>
              <td>${user.name}</td>
              <td>${user.email}</td>
              <td>${user.role}</td>
              <td>
                <span class="badge ${user.active ? 'bg-success' : 'bg-secondary'}">
                  ${user.active ? 'Active' : 'Inactive'}
                </span>
              </td>
              <td>
                <button class="btn btn-sm btn-warning me-1" onclick="editUser('${doc.id}')">
                  <i class="fas fa-edit me-1"></i> Edit
                </button>
                <button class="btn btn-sm btn-danger" onclick="toggleUserStatus('${doc.id}', ${!user.active})">
                  <i class="fas ${user.active ? 'fa-user-slash' : 'fa-user-check'} me-1"></i>
                  ${user.active ? 'Deactivate' : 'Activate'}
                </button>
              </td>
            </tr>
          `;
        });
        
        document.getElementById('userList').innerHTML = html;
      } catch (error) {
        console.error("Error loading users:", error);
      }
    }

    async function addUser() {
      try {
        const userName = document.getElementById('userName').value;
        const userEmail = document.getElementById('userEmail').value;
        const userRole = document.getElementById('userRole').value;
        const userPassword = document.getElementById('userPassword').value;
        
        if (!userName || !userEmail || !userRole || !userPassword) {
          alert('Please fill in all fields');
          return;
        }
        
        if (userPassword.length < 6) {
          alert('Password must be at least 6 characters');
          return;
        }
        
        // Create user in Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(userEmail, userPassword);
        
        // Save additional user data in Firestore
        await db.collection('users').doc(userCredential.user.uid).set({
          name: userName,
          email: userEmail,
          role: userRole,
          active: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Log activity
        await db.collection('activities').add({
          title: 'User Added',
          description: `Added new ${userRole} user: ${userName} (${userEmail})`,
          user: currentUser.email,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('User added successfully!');
        document.getElementById('userForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
        loadUsers();
        loadDashboardData();
      } catch (error) {
        console.error("Error adding user:", error);
        alert('Error adding user: ' + error.message);
      }
    }

    function editUser(userId) {
      // In a real app, this would open an edit modal
      alert(`Edit user with ID: ${userId}`);
    }

    async function toggleUserStatus(userId, newStatus) {
      try {
        const action = newStatus ? 'activate' : 'deactivate';
        if (!confirm(`Are you sure you want to ${action} this user?`)) return;
        
        await db.collection('users').doc(userId).update({
          active: newStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Log activity
        await db.collection('activities').add({
          title: 'User Status Changed',
          description: `${newStatus ? 'Activated' : 'Deactivated'} user ID: ${userId}`,
          user: currentUser.email,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(`User ${newStatus ? 'activated' : 'deactivated'} successfully!`);
        loadUsers();
        loadDashboardData();
      } catch (error) {
        console.error("Error toggling user status:", error);
        alert('Error toggling user status: ' + error.message);
      }
    }

    // Initialize the dashboard when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Google Charts callback
      google.charts.setOnLoadCallback(loadStockDistributionChart);
    });
  </script>
</body>
</html>
