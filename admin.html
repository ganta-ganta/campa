<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Distribution System Admin | Cola</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .sidebar { min-height: 100vh; background-color: #f8f9fa; }
    .nav-link { color: #333; }
    .nav-link.active { color: #0d6efd; font-weight: 500; }
    .badge-status { font-size: 0.8rem; }
    .card-hover { transition: all 0.3s; }
    .card-hover:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-approved { background-color: #d4edda; color: #155724; }
    .status-rejected { background-color: #f8d7da; color: #721c24; }
    .status-delivered { background-color: #cce5ff; color: #004085; }
    .chart-container { position: relative; height: 300px; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 d-md-block sidebar collapse">
        <div class="position-sticky pt-3">
          <div class="text-center mb-4">
            <h4>Cola Distribution</h4>
            <hr>
          </div>
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="#" data-bs-target="dashboard">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-target="warehouse">
                <i class="fas fa-warehouse me-2"></i>Warehouse
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-target="vans">
                <i class="fas fa-truck me-2"></i>Distribution Vans
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-target="orders">
                <i class="fas fa-shopping-cart me-2"></i>Retailer Orders
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-target="operators">
                <i class="fas fa-users-cog me-2"></i>Operators
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-target="reports">
                <i class="fas fa-chart-bar me-2"></i>Reports
              </a>
            </li>
            <li class="nav-item mt-4">
              <a class="nav-link text-danger" href="#" id="logoutBtn">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Admin Dashboard</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
              <button type="button" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-download me-1"></i> Export
              </button>
            </div>
          </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection">
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card text-white bg-primary mb-3 card-hover">
                <div class="card-body">
                  <h5 class="card-title">Total Products</h5>
                  <h2 class="card-text" id="totalProducts">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-success mb-3 card-hover">
                <div class="card-body">
                  <h5 class="card-title">Pending Orders</h5>
                  <h2 class="card-text" id="pendingOrders">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-warning mb-3 card-hover">
                <div class="card-body">
                  <h5 class="card-title">Active Vans</h5>
                  <h2 class="card-text" id="activeVans">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-info mb-3 card-hover">
                <div class="card-body">
                  <h5 class="card-title">Today's Delivery</h5>
                  <h2 class="card-text" id="todaysDelivery">0</h2>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-8">
              <div class="card card-hover">
                <div class="card-header">
                  <h5>Weekly Delivery Trend</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="deliveryChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-hover">
                <div class="card-header">
                  <h5>Inventory Status</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="inventoryChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <h4>Recent Orders</h4>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Retailer</th>
                  <th>Products</th>
                  <th>Van</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody id="recentOrdersTable">
                <!-- Will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Warehouse Section -->
        <div id="warehouseSection" style="display: none;">
          <div class="d-flex justify-content-between mb-3">
            <h4>Warehouse Inventory</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
              <i class="fas fa-plus me-1"></i> Add Product
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Product ID</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Current Stock</th>
                  <th>Threshold</th>
                  <th>Last Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="warehouseList">
                <!-- Will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Vans Section -->
        <div id="vansSection" style="display: none;">
          <div class="d-flex justify-content-between mb-3">
            <h4>Distribution Vans</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVanModal">
              <i class="fas fa-plus me-1"></i> Add Van
            </button>
          </div>
          <div class="row" id="vansGrid">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Orders Section -->
        <div id="ordersSection" style="display: none;">
          <div class="d-flex justify-content-between mb-3">
            <h4>Retailer Orders</h4>
            <div class="btn-group">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                Filter
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item filter-order" data-status="all" href="#">All</a></li>
                <li><a class="dropdown-item filter-order" data-status="pending" href="#">Pending</a></li>
                <li><a class="dropdown-item filter-order" data-status="approved" href="#">Approved</a></li>
                <li><a class="dropdown-item filter-order" data-status="rejected" href="#">Rejected</a></li>
                <li><a class="dropdown-item filter-order" data-status="delivered" href="#">Delivered</a></li>
              </ul>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Retailer</th>
                  <th>Products</th>
                  <th>Total Items</th>
                  <th>Van</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ordersList">
                <!-- Will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Operators Section -->
        <div id="operatorsSection" style="display: none;">
          <div class="d-flex justify-content-between mb-3">
            <h4>System Operators</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOperatorModal">
              <i class="fas fa-plus me-1"></i> Add Operator
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Operator ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Assigned Van</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="operatorsList">
                <!-- Will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Reports Section -->
        <div id="reportsSection" style="display: none;">
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card card-hover">
                <div class="card-header">
                  <h5>Generate Inventory Report</h5>
                </div>
                <div class="card-body">
                  <form id="inventoryReportForm">
                    <div class="mb-3">
                      <label class="form-label">Report Type</label>
                      <select class="form-select" id="inventoryReportType">
                        <option value="low_stock">Low Stock Items</option>
                        <option value="all_items">All Items</option>
                        <option value="category">By Category</option>
                      </select>
                    </div>
                    <div class="mb-3" id="categorySelectContainer" style="display: none;">
                      <label class="form-label">Category</label>
                      <select class="form-select" id="inventoryCategory">
                        <!-- Will be populated by JavaScript -->
                      </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-file-pdf me-1"></i> Generate Report
                    </button>
                  </form>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card card-hover">
                <div class="card-header">
                  <h5>Generate Delivery Report</h5>
                </div>
                <div class="card-body">
                  <form id="deliveryReportForm">
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="form-label">From Date</label>
                        <input type="date" class="form-control" id="deliveryFromDate" required>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">To Date</label>
                        <input type="date" class="form-control" id="deliveryToDate" required>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Van</label>
                      <select class="form-select" id="deliveryVan">
                        <option value="all">All Vans</option>
                        <!-- Will be populated by JavaScript -->
                      </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-file-pdf me-1"></i> Generate Report
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="productForm">
            <div class="mb-3">
              <label class="form-label">Product Name</label>
              <input type="text" class="form-control" id="productName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Category</label>
              <select class="form-select" id="productCategory" required>
                <option value="beverage">Beverage</option>
                <option value="snack">Snack</option>
                <option value="dairy">Dairy</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Initial Stock</label>
                <input type="number" class="form-control" id="productStock" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Low Stock Threshold</label>
                <input type="number" class="form-control" id="productThreshold" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="productDescription" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveProductBtn" class="btn btn-primary">Save Product</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Van Modal -->
  <div class="modal fade" id="addVanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Van</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="vanForm">
            <div class="mb-3">
              <label class="form-label">Van Number</label>
              <input type="text" class="form-control" id="vanNumber" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Capacity (items)</label>
              <input type="number" class="form-control" id="vanCapacity" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Assigned Operator</label>
              <select class="form-select" id="vanOperator">
                <option value="">None</option>
                <!-- Will be populated by JavaScript -->
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" id="vanStatus" required>
                <option value="active">Active</option>
                <option value="maintenance">Maintenance</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveVanBtn" class="btn btn-primary">Save Van</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Operator Modal -->
  <div class="modal fade" id="addOperatorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Operator</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="operatorForm">
            <div class="mb-3">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-control" id="operatorName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="operatorEmail" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-control" id="operatorPhone" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="operatorPassword" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Assigned Van</label>
              <select class="form-select" id="operatorVan">
                <option value="">None</option>
                <!-- Will be populated by JavaScript -->
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveOperatorBtn" class="btn btn-primary">Save Operator</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Order Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="orderModalBody">
          <!-- Will be populated by JavaScript -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="rejectOrderBtn" style="display:none;">Reject Order</button>
          <button type="button" class="btn btn-success" id="approveOrderBtn" style="display:none;">Approve Order</button>
          <button type="button" class="btn btn-primary" id="markDeliveredBtn" style="display:none;">Mark as Delivered</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Details Modal -->
  <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Product Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="productModalBody">
          <!-- Will be populated by JavaScript -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="updateStockBtn" style="display:none;">Update Stock</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Update Stock Modal -->
  <div class="modal fade" id="updateStockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Update Stock</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="updateStockForm">
            <div class="mb-3">
              <label class="form-label">Current Stock</label>
              <input type="number" class="form-control" id="currentStock" disabled>
            </div>
            <div class="mb-3">
              <label class="form-label">Operation</label>
              <select class="form-select" id="stockOperation" required>
                <option value="add">Add Stock</option>
                <option value="remove">Remove Stock</option>
                <option value="set">Set Stock</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Amount</label>
              <input type="number" class="form-control" id="stockAmount" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Reason</label>
              <input type="text" class="form-control" id="stockReason" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveStockBtn" class="btn btn-primary">Update Stock</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Add this at the top of your admin.js script
    // Check authentication state
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'login.html';
      } else {
        db.collection('users').doc(user.uid).get().then(doc => {
          if (!doc.exists || doc.data().role !== 'admin') {
            auth.signOut().then(() => {
              window.location.href = 'login.html';
            });
          }
        });
      }
    });
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBzl1R3xsNUKQ9wO3DX8nHt3O0NkI6Cc_E",
      authDomain: "cola-d7685.firebaseapp.com",
      projectId: "cola-d7685",
      storageBucket: "cola-d7685.appspot.com",
      messagingSenderId: "206120855200",
      appId: "1:206120855200:web:d88691337ce6a1b2dd4bc5",
      measurementId: "G-W3VMM4VNM1"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // DOM elements
    const logoutBtn = document.getElementById('logoutBtn');
    const dashboardSection = document.getElementById('dashboardSection');
    const warehouseSection = document.getElementById('warehouseSection');
    const vansSection = document.getElementById('vansSection');
    const ordersSection = document.getElementById('ordersSection');
    const operatorsSection = document.getElementById('operatorsSection');
    const reportsSection = document.getElementById('reportsSection');
    
    // Modals
    const orderModal = new bootstrap.Modal(document.getElementById('orderModal'));
    const productModal = new bootstrap.Modal(document.getElementById('productModal'));
    const updateStockModal = new bootstrap.Modal(document.getElementById('updateStockModal'));
    const addProductModal = new bootstrap.Modal(document.getElementById('addProductModal'));
    const addVanModal = new bootstrap.Modal(document.getElementById('addVanModal'));
    const addOperatorModal = new bootstrap.Modal(document.getElementById('addOperatorModal'));
    
    // Charts
    let deliveryChart, inventoryChart;
    
    // Current selections
    let currentOrderId = null;
    let currentProductId = null;
    let currentVanId = null;
    let currentOperatorId = null;
    
    // Check auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        // Check if user is admin
        db.collection('users').doc(user.uid).get().then(doc => {
          if (doc.exists && doc.data().role === 'admin') {
            // Admin user - load all data
            loadDashboard();
            loadWarehouse();
            loadVans();
            loadOrders();
            loadOperators();
            setupEventListeners();
          } else {
            // Not admin - redirect
            window.location.href = 'login.html';
          }
        });
      } else {
        // No user signed in - redirect to login
        window.location.href = 'login.html';
      }
    });
    
    // Load dashboard data
    function loadDashboard() {
      // Load product count
      db.collection('products').get().then(snap => {
        document.getElementById('totalProducts').textContent = snap.size;
      });
      
      // Load pending orders count
      db.collection('orders').where('status', '==', 'pending').get().then(snap => {
        document.getElementById('pendingOrders').textContent = snap.size;
      });
      
      // Load active vans count
      db.collection('vans').where('status', '==', 'active').get().then(snap => {
        document.getElementById('activeVans').textContent = snap.size;
      });
      
      // Load today's deliveries
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      db.collection('orders')
        .where('status', '==', 'delivered')
        .where('deliveryDate', '>=', today)
        .get()
        .then(snap => {
          document.getElementById('todaysDelivery').textContent = snap.size;
        });
      
      // Load recent orders
      db.collection('orders')
        .orderBy('orderDate', 'desc')
        .limit(5)
        .get()
        .then(snap => {
          const tableBody = document.getElementById('recentOrdersTable');
          tableBody.innerHTML = '';
          
          snap.forEach(doc => {
            const order = doc.data();
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${doc.id.substring(0, 6)}...</td>
              <td>${order.retailerName}</td>
              <td>${order.items.length} items</td>
              <td>${order.vanNumber || 'Not assigned'}</td>
              <td><span class="badge ${getStatusBadgeClass(order.status)}">${order.status}</span></td>
              <td>${order.orderDate.toDate().toLocaleDateString()}</td>
            `;
            tableBody.appendChild(row);
          });
        });
      
      // Load charts
      loadCharts();
    }
    
    // Load charts
    function loadCharts() {
      // Weekly delivery chart
      const deliveryCtx = document.getElementById('deliveryChart').getContext('2d');
      
      // Sample data - in a real app, you would fetch this from Firestore
      const deliveryData = {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
          label: 'Deliveries',
          data: [12, 19, 15, 20, 18, 25, 22],
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      };
      
      deliveryChart = new Chart(deliveryCtx, {
        type: 'bar',
        data: deliveryData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Inventory chart
      const inventoryCtx = document.getElementById('inventoryChart').getContext('2d');
      
      // Sample data - in a real app, you would fetch this from Firestore
      const inventoryData = {
        labels: ['Beverage', 'Snack', 'Dairy', 'Other'],
        datasets: [{
          data: [300, 150, 100, 50],
          backgroundColor: [
            'rgba(255, 99, 132, 0.2)',
            'rgba(54, 162, 235, 0.2)',
            'rgba(255, 206, 86, 0.2)',
            'rgba(75, 192, 192, 0.2)'
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)'
          ],
          borderWidth: 1
        }]
      };
      
      inventoryChart = new Chart(inventoryCtx, {
        type: 'doughnut',
        data: inventoryData,
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }
    
    // Load warehouse inventory
    function loadWarehouse() {
      db.collection('products').orderBy('name').onSnapshot(snap => {
        const warehouseList = document.getElementById('warehouseList');
        warehouseList.innerHTML = '';
        
        if (snap.empty) {
          warehouseList.innerHTML = `
            <tr>
              <td colspan="7" class="text-center py-5"><h6 class="text-muted">No products found</h6></td>
            </tr>
          `;
          return;
        }
        
        snap.forEach(doc => {
          const product = doc.data();
          addProductRow(product, doc.id);
        });
        
        // Update category dropdown in reports
        updateCategoryDropdown();
      }, error => {
        console.error("Error getting products: ", error);
      });
    }
    
    function addProductRow(product, productId) {
      const row = document.createElement('tr');
      row.className = 'card-hover';
      
      const stockClass = product.currentStock <= product.lowStockThreshold ? 'text-danger fw-bold' : '';
      
      row.innerHTML = `
        <td>${productId.substring(0, 6)}...</td>
        <td>${product.name}</td>
        <td>${product.category}</td>
        <td class="${stockClass}">${product.currentStock}</td>
        <td>${product.lowStockThreshold}</td>
        <td>${product.lastUpdated?.toDate().toLocaleDateString() || 'N/A'}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary view-product" data-product-id="${productId}">
            <i class="fas fa-eye me-1"></i> View
          </button>
          <button class="btn btn-sm btn-outline-warning update-stock ms-1" data-product-id="${productId}">
            <i class="fas fa-edit me-1"></i> Update
          </button>
        </td>
      `;
      
      document.getElementById('warehouseList').appendChild(row);
    }
    
    // Load vans
    function loadVans() {
      db.collection('vans').orderBy('number').onSnapshot(snap => {
        const vansGrid = document.getElementById('vansGrid');
        vansGrid.innerHTML = '';
        
        if (snap.empty) {
          vansGrid.innerHTML = `
            <div class="col-12 text-center py-5">
              <h6 class="text-muted">No vans found</h6>
            </div>
          `;
          return;
        }
        
        snap.forEach(doc => {
          const van = doc.data();
          addVanCard(van, doc.id);
        });
        
        // Update van dropdowns in other forms
        updateVanDropdowns();
      }, error => {
        console.error("Error getting vans: ", error);
      });
    }
    
    function addVanCard(van, vanId) {
      const col = document.createElement('div');
      col.className = 'col-md-4 mb-4';
      
      let statusBadgeClass = 'bg-secondary';
      if (van.status === 'active') statusBadgeClass = 'bg-success';
      else if (van.status === 'maintenance') statusBadgeClass = 'bg-warning text-dark';
      else if (van.status === 'inactive') statusBadgeClass = 'bg-danger';
      
      col.innerHTML = `
        <div class="card h-100 card-hover">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">${van.number}</h5>
            <span class="badge ${statusBadgeClass}">${van.status}</span>
          </div>
          <div class="card-body">
            <p class="card-text"><strong>Capacity:</strong> ${van.capacity} items</p>
            <p class="card-text"><strong>Current Load:</strong> ${van.currentLoad || 0} items</p>
            <p class="card-text"><strong>Operator:</strong> ${van.operatorName || 'None'}</p>
            <div class="progress mt-3">
              <div class="progress-bar" role="progressbar" 
                   style="width: ${(van.currentLoad || 0) / van.capacity * 100}%" 
                   aria-valuenow="${van.currentLoad || 0}" 
                   aria-valuemin="0" 
                   aria-valuemax="${van.capacity}">
              </div>
            </div>
          </div>
          <div class="card-footer bg-white">
            <button class="btn btn-sm btn-outline-primary edit-van" data-van-id="${vanId}">
              <i class="fas fa-edit me-1"></i> Edit
            </button>
            <button class="btn btn-sm btn-outline-danger delete-van ms-1" data-van-id="${vanId}">
              <i class="fas fa-trash me-1"></i> Delete
            </button>
          </div>
        </div>
      `;
      
      document.getElementById('vansGrid').appendChild(col);
    }
    
    // Load orders
    function loadOrders(filter = 'all') {
      let query = db.collection('orders').orderBy('orderDate', 'desc');
      
      if (filter !== 'all') {
        query = query.where('status', '==', filter);
      }
      
      query.onSnapshot(snap => {
        const ordersList = document.getElementById('ordersList');
        ordersList.innerHTML = '';
        
        if (snap.empty) {
          ordersList.innerHTML = `
            <tr>
              <td colspan="8" class="text-center py-5"><h6 class="text-muted">No orders found</h6></td>
            </tr>
          `;
          return;
        }
        
        snap.forEach(doc => {
          const order = doc.data();
          addOrderRow(order, doc.id);
        });
      }, error => {
        console.error("Error getting orders: ", error);
      });
    }
    
    function addOrderRow(order, orderId) {
      const row = document.createElement('tr');
      row.className = 'card-hover';
      
      // Calculate total items
      const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
      
      row.innerHTML = `
        <td>${orderId.substring(0, 6)}...</td>
        <td>${order.retailerName}</td>
        <td>${order.items.length} products</td>
        <td>${totalItems}</td>
        <td>${order.vanNumber || 'Not assigned'}</td>
        <td><span class="badge ${getStatusBadgeClass(order.status)}">${order.status}</span></td>
        <td>${order.orderDate.toDate().toLocaleDateString()}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary view-order" data-order-id="${orderId}">
            <i class="fas fa-eye me-1"></i> View
          </button>
          ${order.status === 'pending' ? `
            <button class="btn btn-sm btn-success approve-order ms-1" data-order-id="${orderId}">
              <i class="fas fa-check me-1"></i> Approve
            </button>
            <button class="btn btn-sm btn-danger reject-order ms-1" data-order-id="${orderId}">
              <i class="fas fa-times me-1"></i> Reject
            </button>
          ` : ''}
          ${order.status === 'approved' ? `
            <button class="btn btn-sm btn-primary deliver-order ms-1" data-order-id="${orderId}">
              <i class="fas fa-truck me-1"></i> Deliver
            </button>
          ` : ''}
        </td>
      `;
      
      document.getElementById('ordersList').appendChild(row);
    }
    
    // Load operators
    function loadOperators() {
      db.collection('users')
        .where('role', '==', 'operator')
        .orderBy('name')
        .onSnapshot(snap => {
          const operatorsList = document.getElementById('operatorsList');
          operatorsList.innerHTML = '';
          
          if (snap.empty) {
            operatorsList.innerHTML = `
              <tr>
                <td colspan="7" class="text-center py-5"><h6 class="text-muted">No operators found</h6></td>
              </tr>
            `;
            return;
          }
          
          snap.forEach(doc => {
            const operator = doc.data();
            addOperatorRow(operator, doc.id);
          });
          
          // Update operator dropdowns in other forms
          updateOperatorDropdowns();
        }, error => {
          console.error("Error getting operators: ", error);
        });
    }
    
    function addOperatorRow(operator, operatorId) {
      const row = document.createElement('tr');
      row.className = 'card-hover';
      
      row.innerHTML = `
        <td>${operatorId.substring(0, 6)}...</td>
        <td>${operator.name}</td>
        <td>${operator.email}</td>
        <td>${operator.phone || 'N/A'}</td>
        <td>${operator.assignedVan || 'None'}</td>
        <td>
          <span class="badge ${operator.isActive ? 'bg-success' : 'bg-secondary'}">
            ${operator.isActive ? 'Active' : 'Inactive'}
          </span>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-primary edit-operator" data-operator-id="${operatorId}">
            <i class="fas fa-edit me-1"></i> Edit
          </button>
          <button class="btn btn-sm btn-outline-danger toggle-operator ms-1" 
                  data-operator-id="${operatorId}" 
                  data-current-status="${operator.isActive}">
            ${operator.isActive ? 'Deactivate' : 'Activate'}
          </button>
        </td>
      `;
      
      document.getElementById('operatorsList').appendChild(row);
    }
    
    // Helper function to get status badge class
    function getStatusBadgeClass(status) {
      switch(status) {
        case 'pending':
          return 'bg-warning text-dark';
        case 'approved':
          return 'bg-success';
        case 'rejected':
          return 'bg-danger';
        case 'delivered':
          return 'bg-info';
        default:
          return 'bg-secondary';
      }
    }
    
    // Update category dropdown in reports
    function updateCategoryDropdown() {
      const categorySelect = document.getElementById('inventoryCategory');
      categorySelect.innerHTML = '';
      
      // Get unique categories from products
      db.collection('products').get().then(snap => {
        const categories = new Set();
        snap.forEach(doc => {
          categories.add(doc.data().category);
        });
        
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
          categorySelect.appendChild(option);
        });
      });
    }
    
    // Update van dropdowns in other forms
    function updateVanDropdowns() {
      const vanSelects = [
        document.getElementById('vanOperator'), // In add van modal
        document.getElementById('operatorVan'), // In add operator modal
        document.getElementById('deliveryVan') // In reports
      ];
      
      db.collection('vans').orderBy('number').get().then(snap => {
        vanSelects.forEach(select => {
          // Clear existing options except the first one
          while (select.options.length > 1) {
            select.remove(1);
          }
          
          // Add new options
          snap.forEach(doc => {
            const van = doc.data();
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = `${van.number} (${van.status})`;
            select.appendChild(option);
          });
        });
      });
    }
    
    // Update operator dropdowns in other forms
    function updateOperatorDropdowns() {
      const operatorSelect = document.getElementById('vanOperator'); // In add van modal
      
      db.collection('users')
        .where('role', '==', 'operator')
        .where('isActive', '==', true)
        .orderBy('name')
        .get()
        .then(snap => {
          // Clear existing options except the first one
          while (operatorSelect.options.length > 1) {
            operatorSelect.remove(1);
          }
          
          // Add new options
          snap.forEach(doc => {
            const operator = doc.data();
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = `${operator.name} (${operator.email})`;
            operatorSelect.appendChild(option);
          });
        });
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Navigation
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Update active nav link
          document.querySelectorAll('.nav-link').forEach(navLink => {
            navLink.classList.remove('active');
          });
          this.classList.add('active');
          
          // Show corresponding section
          const target = this.getAttribute('data-bs-target');
          dashboardSection.style.display = 'none';
          warehouseSection.style.display = 'none';
          vansSection.style.display = 'none';
          ordersSection.style.display = 'none';
          operatorsSection.style.display = 'none';
          reportsSection.style.display = 'none';
          
          switch(target) {
            case 'dashboard':
              dashboardSection.style.display = 'block';
              loadDashboard();
              break;
            case 'warehouse':
              warehouseSection.style.display = 'block';
              loadWarehouse();
              break;
            case 'vans':
              vansSection.style.display = 'block';
              loadVans();
              break;
            case 'orders':
              ordersSection.style.display = 'block';
              loadOrders();
              break;
            case 'operators':
              operatorsSection.style.display = 'block';
              loadOperators();
              break;
            case 'reports':
              reportsSection.style.display = 'block';
              break;
          }
        });
      });

      // Logout
      logoutBtn.addEventListener('click', () => {
        auth.signOut().then(() => {
          window.location.href = 'login.html';
        });
      });

      // Order filters
      document.querySelectorAll('.filter-order').forEach(filter => {
        filter.addEventListener('click', (e) => {
          e.preventDefault();
          const status = filter.getAttribute('data-status');
          loadOrders(status);
        });
      });

      // Inventory report type change
      document.getElementById('inventoryReportType').addEventListener('change', (e) => {
        const categorySelectContainer = document.getElementById('categorySelectContainer');
        if (e.target.value === 'category') {
          categorySelectContainer.style.display = 'block';
        } else {
          categorySelectContainer.style.display = 'none';
        }
      });

      // View order details
      document.addEventListener('click', (e) => {
        if (e.target.closest('.view-order')) {
          const orderId = e.target.closest('.view-order').getAttribute('data-order-id');
          viewOrderDetails(orderId);
        }
        
        // Approve order
        if (e.target.closest('.approve-order')) {
          const orderId = e.target.closest('.approve-order').getAttribute('data-order-id');
          approveOrder(orderId);
        }
        
        // Reject order
        if (e.target.closest('.reject-order')) {
          const orderId = e.target.closest('.reject-order').getAttribute('data-order-id');
          rejectOrder(orderId);
        }
        
        // Deliver order
        if (e.target.closest('.deliver-order')) {
          const orderId = e.target.closest('.deliver-order').getAttribute('data-order-id');
          deliverOrder(orderId);
        }
        
        // View product details
        if (e.target.closest('.view-product')) {
          const productId = e.target.closest('.view-product').getAttribute('data-product-id');
          viewProductDetails(productId);
        }
        
        // Update product stock
        if (e.target.closest('.update-stock')) {
          const productId = e.target.closest('.update-stock').getAttribute('data-product-id');
          showUpdateStockModal(productId);
        }
        
        // Edit van
        if (e.target.closest('.edit-van')) {
          const vanId = e.target.closest('.edit-van').getAttribute('data-van-id');
          editVan(vanId);
        }
        
        // Delete van
        if (e.target.closest('.delete-van')) {
          const vanId = e.target.closest('.delete-van').getAttribute('data-van-id');
          deleteVan(vanId);
        }
        
        // Edit operator
        if (e.target.closest('.edit-operator')) {
          const operatorId = e.target.closest('.edit-operator').getAttribute('data-operator-id');
          editOperator(operatorId);
        }
        
        // Toggle operator status
        if (e.target.closest('.toggle-operator')) {
          const operatorId = e.target.closest('.toggle-operator').getAttribute('data-operator-id');
          const currentStatus = e.target.closest('.toggle-operator').getAttribute('data-current-status') === 'true';
          toggleOperatorStatus(operatorId, !currentStatus);
        }
      });

      // Save new product
      document.getElementById('saveProductBtn').addEventListener('click', () => {
        saveNewProduct();
      });

      // Save new van
      document.getElementById('saveVanBtn').addEventListener('click', () => {
        saveNewVan();
      });

      // Save new operator
      document.getElementById('saveOperatorBtn').addEventListener('click', () => {
        saveNewOperator();
      });

      // Save stock update
      document.getElementById('saveStockBtn').addEventListener('click', () => {
        updateProductStock();
      });

      // Approve order from modal
      document.getElementById('approveOrderBtn').addEventListener('click', () => {
        if (currentOrderId) {
          approveOrder(currentOrderId);
          orderModal.hide();
        }
      });

      // Reject order from modal
      document.getElementById('rejectOrderBtn').addEventListener('click', () => {
        if (currentOrderId) {
          rejectOrder(currentOrderId);
          orderModal.hide();
        }
      });

      // Mark as delivered from modal
      document.getElementById('markDeliveredBtn').addEventListener('click', () => {
        if (currentOrderId) {
          deliverOrder(currentOrderId);
          orderModal.hide();
        }
      });

      // Update stock from modal
      document.getElementById('updateStockBtn').addEventListener('click', () => {
        if (currentProductId) {
          showUpdateStockModal(currentProductId);
        }
      });
    }
    
    // View order details
    async function viewOrderDetails(orderId) {
      currentOrderId = orderId;
      
      const doc = await db.collection('orders').doc(orderId).get();
      if (!doc.exists) {
        alert('Order not found');
        return;
      }
      
      const order = doc.data();
      const modalBody = document.getElementById('orderModalBody');
      
      // Calculate total items and value
      const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
      const totalValue = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      // Create items table
      let itemsTable = `
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Unit Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      order.items.forEach(item => {
        itemsTable += `
          <tr>
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>₹${item.price}</td>
            <td>₹${item.price * item.quantity}</td>
          </tr>
        `;
      });
      
      itemsTable += `
          </tbody>
          <tfoot>
            <tr>
              <th colspan="3">Total</th>
              <th>₹${totalValue}</th>
            </tr>
          </tfoot>
        </table>
      `;
      
      modalBody.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-muted">Order Information</h6>
            <p><strong>Order ID:</strong> ${orderId}</p>
            <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(order.status)}">${order.status}</span></p>
            <p><strong>Order Date:</strong> ${order.orderDate.toDate().toLocaleString()}</p>
            <p><strong>Total Items:</strong> ${totalItems}</p>
            <p><strong>Total Value:</strong> ₹${totalValue}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted">Retailer Information</h6>
            <p><strong>Retailer:</strong> ${order.retailerName}</p>
            <p><strong>Contact:</strong> ${order.retailerPhone}</p>
            <p><strong>Address:</strong> ${order.retailerAddress}</p>
            <p><strong>Delivery Instructions:</strong> ${order.deliveryInstructions || 'None'}</p>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <h6 class="text-muted">Delivery Information</h6>
            <p><strong>Van:</strong> ${order.vanNumber || 'Not assigned'}</p>
            <p><strong>Driver:</strong> ${order.driverName || 'Not assigned'}</p>
            ${order.deliveryDate ? `
              <p><strong>Delivery Date:</strong> ${order.deliveryDate.toDate().toLocaleDateString()}</p>
            ` : ''}
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12">
            <h6 class="text-muted">Order Items</h6>
            ${itemsTable}
          </div>
        </div>
      `;
      
      // Show appropriate action buttons
      document.getElementById('rejectOrderBtn').style.display = 'none';
      document.getElementById('approveOrderBtn').style.display = 'none';
      document.getElementById('markDeliveredBtn').style.display = 'none';
      
      if (order.status === 'pending') {
        document.getElementById('approveOrderBtn').style.display = 'inline-block';
        document.getElementById('rejectOrderBtn').style.display = 'inline-block';
      } else if (order.status === 'approved') {
        document.getElementById('markDeliveredBtn').style.display = 'inline-block';
      }
      
      orderModal.show();
    }
    
    // View product details
    async function viewProductDetails(productId) {
      currentProductId = productId;
      
      const doc = await db.collection('products').doc(productId).get();
      if (!doc.exists) {
        alert('Product not found');
        return;
      }
      
      const product = doc.data();
      const modalBody = document.getElementById('productModalBody');
      
      modalBody.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-muted">Product Information</h6>
            <p><strong>Product ID:</strong> ${productId}</p>
            <p><strong>Name:</strong> ${product.name}</p>
            <p><strong>Category:</strong> ${product.category}</p>
            <p><strong>Current Stock:</strong> ${product.currentStock}</p>
            <p><strong>Low Stock Threshold:</strong> ${product.lowStockThreshold}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted">Stock Status</h6>
            <div class="progress mb-3" style="height: 30px;">
              <div class="progress-bar" role="progressbar" 
                   style="width: ${(product.currentStock / (product.lowStockThreshold * 2)) * 100}%" 
                   aria-valuenow="${product.currentStock}" 
                   aria-valuemin="0" 
                   aria-valuemax="${product.lowStockThreshold * 2}">
                ${product.currentStock} / ${product.lowStockThreshold * 2}
              </div>
            </div>
            <p><strong>Last Updated:</strong> ${product.lastUpdated?.toDate().toLocaleString() || 'N/A'}</p>
            <p><strong>Description:</strong> ${product.description || 'None'}</p>
          </div>
        </div>
      `;
      
      // Show update stock button
      document.getElementById('updateStockBtn').style.display = 'inline-block';
      
      productModal.show();
    }
    
    // Show update stock modal
    async function showUpdateStockModal(productId) {
      currentProductId = productId;
      
      const doc = await db.collection('products').doc(productId).get();
      if (!doc.exists) {
        alert('Product not found');
        return;
      }
      
      const product = doc.data();
      document.getElementById('currentStock').value = product.currentStock;
      
      // Reset form
      document.getElementById('stockOperation').value = 'add';
      document.getElementById('stockAmount').value = '';
      document.getElementById('stockReason').value = '';
      
      updateStockModal.show();
    }
    
    // Approve order
    function approveOrder(orderId) {
      if (!confirm('Are you sure you want to approve this order?')) return;
      
      // In a real app, you would also check stock availability here
      
      db.collection('orders').doc(orderId).update({
        status: 'approved',
        approvedDate: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('Order approved successfully');
      })
      .catch(error => {
        console.error("Error approving order: ", error);
        alert('Failed to approve order');
      });
    }
    
    // Reject order
    function rejectOrder(orderId) {
      const reason = prompt('Please enter the reason for rejection:');
      if (!reason) return;
      
      db.collection('orders').doc(orderId).update({
        status: 'rejected',
        rejectionReason: reason,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('Order rejected successfully');
      })
      .catch(error => {
        console.error("Error rejecting order: ", error);
        alert('Failed to reject order');
      });
    }
    
    // Deliver order
    function deliverOrder(orderId) {
      if (!confirm('Are you sure you want to mark this order as delivered?')) return;
      
      db.collection('orders').doc(orderId).update({
        status: 'delivered',
        deliveryDate: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('Order marked as delivered successfully');
      })
      .catch(error => {
        console.error("Error delivering order: ", error);
        alert('Failed to mark order as delivered');
      });
    }
    
    // Save new product
    function saveNewProduct() {
      const name = document.getElementById('productName').value;
      const category = document.getElementById('productCategory').value;
      const stock = parseInt(document.getElementById('productStock').value);
      const threshold = parseInt(document.getElementById('productThreshold').value);
      const description = document.getElementById('productDescription').value;
      
      if (!name || isNaN(stock) || isNaN(threshold)) {
        alert('Please fill all required fields');
        return;
      }
      
      const newProduct = {
        name,
        category,
        currentStock: stock,
        lowStockThreshold: threshold,
        description,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      db.collection('products').add(newProduct)
        .then(() => {
          alert('Product added successfully');
          addProductModal.hide();
          document.getElementById('productForm').reset();
        })
        .catch(error => {
          console.error("Error adding product: ", error);
          alert('Failed to add product');
        });
    }
    
    // Save new van
    function saveNewVan() {
      const number = document.getElementById('vanNumber').value;
      const capacity = parseInt(document.getElementById('vanCapacity').value);
      const operatorId = document.getElementById('vanOperator').value;
      const status = document.getElementById('vanStatus').value;
      
      if (!number || isNaN(capacity)) {
        alert('Please fill all required fields');
        return;
      }
      
      // Get operator details if assigned
      let operatorName = '';
      if (operatorId) {
        db.collection('users').doc(operatorId).get().then(doc => {
          if (doc.exists) {
            operatorName = doc.data().name;
            
            const newVan = {
              number,
              capacity,
              operatorId,
              operatorName,
              status,
              currentLoad: 0,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            saveVanToFirestore(newVan);
          }
        });
      } else {
        const newVan = {
          number,
          capacity,
          status,
          currentLoad: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        saveVanToFirestore(newVan);
      }
    }
    
    function saveVanToFirestore(vanData) {
      db.collection('vans').add(vanData)
        .then(() => {
          alert('Van added successfully');
          addVanModal.hide();
          document.getElementById('vanForm').reset();
        })
        .catch(error => {
          console.error("Error adding van: ", error);
          alert('Failed to add van');
        });
    }
    
    // Save new operator
    function saveNewOperator() {
      const name = document.getElementById('operatorName').value;
      const email = document.getElementById('operatorEmail').value;
      const phone = document.getElementById('operatorPhone').value;
      const password = document.getElementById('operatorPassword').value;
      const vanId = document.getElementById('operatorVan').value;
      
      if (!name || !email || !phone || !password) {
        alert('Please fill all required fields');
        return;
      }
      
      // Create user in Firebase Auth
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const userId = userCredential.user.uid;
          
          // Get van details if assigned
          let vanNumber = '';
          if (vanId) {
            db.collection('vans').doc(vanId).get().then(doc => {
              if (doc.exists) {
                vanNumber = doc.data().number;
                
                const newOperator = {
                  name,
                  email,
                  phone,
                  role: 'operator',
                  isActive: true,
                  assignedVan: vanId,
                  assignedVanNumber: vanNumber,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                saveOperatorToFirestore(userId, newOperator);
              }
            });
          } else {
            const newOperator = {
              name,
              email,
              phone,
              role: 'operator',
              isActive: true,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            saveOperatorToFirestore(userId, newOperator);
          }
        })
        .catch((error) => {
          console.error("Error creating operator: ", error);
          alert('Failed to create operator: ' + error.message);
        });
    }
    
    function saveOperatorToFirestore(userId, operatorData) {
      db.collection('users').doc(userId).set(operatorData)
        .then(() => {
          alert('Operator added successfully');
          addOperatorModal.hide();
          document.getElementById('operatorForm').reset();
          
          // Update the van with operator assignment if applicable
          if (operatorData.assignedVan) {
            db.collection('vans').doc(operatorData.assignedVan).update({
              operatorId: userId,
              operatorName: operatorData.name,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        })
        .catch(error => {
          console.error("Error adding operator: ", error);
          alert('Failed to add operator');
        });
    }
    
    // Update product stock
    function updateProductStock() {
      const operation = document.getElementById('stockOperation').value;
      const amount = parseInt(document.getElementById('stockAmount').value);
      const reason = document.getElementById('stockReason').value;
      
      if (isNaN(amount) || !reason) {
        alert('Please fill all required fields');
        return;
      }
      
      db.collection('products').doc(currentProductId).get().then(doc => {
        if (!doc.exists) {
          alert('Product not found');
          return;
        }
        
        const product = doc.data();
        let newStock = product.currentStock;
        
        switch(operation) {
          case 'add':
            newStock += amount;
            break;
          case 'remove':
            newStock -= amount;
            if (newStock < 0) newStock = 0;
            break;
          case 'set':
            newStock = amount;
            break;
        }
        
        // Create stock movement record
        const stockMovement = {
          productId: currentProductId,
          productName: product.name,
          previousStock: product.currentStock,
          newStock,
          amount,
          operation,
          reason,
          date: firebase.firestore.FieldValue.serverTimestamp(),
          userId: auth.currentUser.uid,
          userName: 'Admin' // In a real app, you would get the user's name
        };
        
        // Update product stock
        db.collection('products').doc(currentProductId).update({
          currentStock: newStock,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          // Add stock movement record
          return db.collection('stockMovements').add(stockMovement);
        })
        .then(() => {
          alert('Stock updated successfully');
          updateStockModal.hide();
        })
        .catch(error => {
          console.error("Error updating stock: ", error);
          alert('Failed to update stock');
        });
      });
    }
    
    // Edit van (placeholder - would need a separate edit modal)
    function editVan(vanId) {
      alert('Edit van functionality would be implemented here');
      // Would need to fetch van details and populate an edit modal
    }
    
    // Delete van
    function deleteVan(vanId) {
      if (!confirm('Are you sure you want to delete this van? This cannot be undone.')) return;
      
      db.collection('vans').doc(vanId).delete()
        .then(() => {
          alert('Van deleted successfully');
        })
        .catch(error => {
          console.error("Error deleting van: ", error);
          alert('Failed to delete van');
        });
    }
    
    // Edit operator (placeholder - would need a separate edit modal)
    function editOperator(operatorId) {
      alert('Edit operator functionality would be implemented here');
      // Would need to fetch operator details and populate an edit modal
    }
    
    // Toggle operator status
    function toggleOperatorStatus(operatorId, newStatus) {
      db.collection('users').doc(operatorId).update({
        isActive: newStatus,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert(`Operator ${newStatus ? 'activated' : 'deactivated'} successfully`);
      })
      .catch(error => {
        console.error("Error toggling operator status: ", error);
        alert('Failed to update operator status');
      });
    }
  </script>
</body>
</html>
